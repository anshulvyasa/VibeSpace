name: Deploy express backend to ec2 

on: 
    push: 
        branches: 
            - main

env: 
    DOCKER_IMAGE_NAME: vibespace-backend
    EC2_USERNAME: ubuntu            

            
jobs: 
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: checkout-code
              uses: actions/checkout@v2
            
            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v2
              
            - name: Login in to dockerhub
              uses: docker/login-action@v2 
              with:
                username: ${{ secrets.DOCKER_HUB_USERNAME }} 
                password: ${{ secrets.DOCKER_HUB_TOKEN }}   
            
            - name: build and push docker image
              uses: docker/build-push-action@v2  
              with: 
                context: ./Server1
                file: ./Server1/dockerfile 
                push: true
                tags: ${{ secrets.DOCKER_HUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest

            - name: Deploy to ec2
              uses: appleboy/ssh-action@master
              env: 
                 ORIGIN: ${{ secrets.ORIGIN }} 
                 MONGODB_URI: ${{ secrets.MONGODB_URI }}
                 DB_NAME: ${{ secrets.DB_NAME }}
                 ACCESS_TOKEN_SECRET: ${{ secrets.ACCESS_TOKEN_SECRET }}
                 ACCESS_TOKEN_EXPIRY: ${{ secrets.ACCESS_TOKEN_EXPIRY }}
                 RESET_TOKEN_SECRET: ${{ secrets.RESET_TOKEN_SECRET }}
                 RESET_TOKEN_EXPIRY: ${{ secrets.RESET_TOKEN_EXPIRY }}
                 CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
                 CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
                 CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
                 EMAIL_USER: ${{ secrets.EMAIL_USER }}
                 EMAIL_PASSKEY: ${{ secrets.EMAIL_PASSKEY }}
              with: 
                host: ${{ secrets.EC2_Host }}
                username: ${{ env.EC2_USERNAME}} 
                key: ${{ secrets.EC2_Key }}    
                